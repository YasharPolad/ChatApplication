<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slacker</title>
    <script src="signalr/signalr.min.js"></script>     
</head>
<body>
    Access Token
    <input type="text" id="accessToken">

    <button style="color: green;" id="connectButton">Connect!</button>

    Connection Id
    <input type="number" id="connectionId">
    Message
    <input type="text" id="inputMessage">
    <button type="submit" id="sendButton">Send</button>

    <div id = "messagesList", style="border-width: 0.05cm; border-color: brown; border-style: solid;min-height: 3cm;width: 70%;"></div>

 



    <script>
        const inputBox = document.getElementById("inputMessage");
        const messageBox = document.getElementById("messagesList");
        const channel = document.getElementById("connectionId");
        const sendButton = document.getElementById("sendButton");
        var loginToken = document.getElementById("accessToken");
        var connectButton = document.getElementById("connectButton");
        
        
        const connection = new signalR.HubConnectionBuilder()
                            .withUrl("http://localhost:5281/chat", { accessTokenFactory: () => this.loginToken.value })
                            .build();
        document.getElementById("sendButton").disabled = true;
           

        
        connectButton.addEventListener("click", () => {
            connection.start().then(function () {
            document.getElementById("sendButton").disabled = false;
            }).catch(function (err) {
                return console.error(err.toString());
            });

        })
        


        //Triggers

        connection.on("messageReceiver", (message, user, ts) => {
            
            yourMessage(message, user, ts);
            
        })


        // Methods

        sendButton.addEventListener("click", () => {
            var message = inputBox.value;
            var channelId = channel.value;
            var ts = Date.now().toString();
            connection.invoke("SendMessageAsync", message, channelId, ts)
                      .catch(error => console.log(`An error was encountered ${error}`));

            myMessage(message, ts);
        })

        function myMessage(message, ts){
            var messageWrapper = document.createElement("div");
            
            messageWrapper.style.height = "1cm";
            var messageDiv = document.createElement("div");
            messageDiv.setAttribute("ts", ts);
            messageDiv.style.backgroundColor = "beige";
            messageDiv.style.width = "30%";
            messageDiv.style.float = "right";
            messageDiv.style.borderRadius = "1cm";
            messageDiv.innerHTML = "Me: " + message;

            messageWrapper.append(messageDiv);
            messageBox.append(messageWrapper);
        }

        function yourMessage(message, user, ts)
        {
            var messageWrapper = document.createElement("div");
            
            messageWrapper.style.height = "1cm";

            var messageDiv = document.createElement("div");
            messageDiv.setAttribute("ts", ts);
            messageDiv.style.backgroundColor = "grey";
            messageDiv.style.width = "30%";
            messageDiv.style.borderRadius = "1cm";
            messageDiv.innerHTML = user + ": " + message;

            messageWrapper.append(messageDiv);
            messageBox.append(messageWrapper);
        }


    </script> 
</body>
</html>